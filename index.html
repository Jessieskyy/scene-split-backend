<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scene Cut Detector</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .scene {
      background: white;
      margin: 0.5rem 0;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      margin: 0.5rem 0.25rem;
    }
  </style>
</head>
<body>

<h1>‚ú® Scene Cut Detector ‚ú®</h1>
<input type="file" id="videoUpload" accept="video/*" />
<button id="processBtn">‚ñ∂Ô∏è Detect Scenes</button>

<div id="loadingOverlay">‚è≥ Processing video, please wait...</div>

<div id="sceneList"></div>

<div id="downloadOptions" style="display: none;">
  <button id="downloadZipBtn">üì¶ Download All Selected Scenes (.zip)</button>
  <button id="downloadTimecodesBtn">üïí Export Timecodes (.txt)</button>
</div>

<script>
  const BACKEND_URL = "https://scene-split-backend.onrender.com";
  let currentScenes = [];

  const showLoading = (text = "Processing...") => {
    const overlay = document.getElementById("loadingOverlay");
    overlay.innerText = text;
    overlay.style.display = "flex";
  };

  const hideLoading = () => {
    document.getElementById("loadingOverlay").style.display = "none";
  };

  document.getElementById("processBtn").addEventListener("click", async () => {
    const file = document.getElementById("videoUpload").files[0];
    if (!file) return alert("Please upload a video.");

    showLoading("‚è≥ Uploading and detecting scenes...");

    const formData = new FormData();
    formData.append("video", file);

    try {
      const res = await fetch(`${BACKEND_URL}/detect`, {
        method: "POST",
        body: formData
      });

      const scenes = await res.json();
      hideLoading();

      if (!scenes || scenes.length === 0) {
        alert("No scenes detected.");
        return;
      }

      currentScenes = scenes;
      const list = document.getElementById("sceneList");
      list.innerHTML = "<h3>üé¨ Detected Scenes:</h3>";

      scenes.forEach((scene, i) => {
        const div = document.createElement("div");
        div.className = "scene";
        div.innerHTML = `
          <label>
            <input type="checkbox" data-index="${i}" checked>
            Scene ${i + 1}: ${scene.start}s ‚Üí ${scene.end}s
          </label>
          <button onclick="downloadScene(${i})">üì• Download This Scene</button>
        `;
        list.appendChild(div);
      });

      document.getElementById("downloadOptions").style.display = "block";

    } catch (err) {
      hideLoading();
      console.error("Error:", err);
      alert("Failed to detect scenes.");
    }
  });

  async function downloadScene(index) {
    const res = await fetch(`${BACKEND_URL}/export`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ indices: [index] })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `scene_${index + 1}.zip`;
    a.click();
  }

  document.getElementById("downloadZipBtn").addEventListener("click", async () => {
    const checked = [...document.querySelectorAll('input[type="checkbox"]:checked')]
      .map(cb => parseInt(cb.dataset.index));

    if (checked.length === 0) return alert("No scenes selected.");

    const res = await fetch(`${BACKEND_URL}/export`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ indices: checked })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "scenes.zip";
    a.click();
  });

  document.getElementById("downloadTimecodesBtn").addEventListener("click", () => {
    if (!currentScenes.length) return alert("No scenes detected.");
    const lines = currentScenes.map((scene, i) => `Scene ${i + 1}: ${scene.start}s - ${scene.end}s`).join("\n");
    const blob = new Blob([lines], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "timecodes.txt";
    a.click();
  });
</script>
</body>
</html>
