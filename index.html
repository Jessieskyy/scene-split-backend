<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Scene Cut Detector</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>‚ú® Scene Cut Detector ‚ú®</h1>
  <input type="file" id="videoUpload" accept="video/*" />
  <button id="processBtn">‚ñ∂Ô∏è Detect Scenes</button>

  <div id="sceneList"></div>

  <div id="downloadOptions" style="display: none; margin-top: 20px;">
    <button id="downloadZipBtn">üì¶ Download All Scenes (.zip)</button>
    <button id="downloadTimecodesBtn">üïí Export Timecodes (.txt)</button>
  </div>

  <script>
    const BACKEND_URL = "https://scene-split-backend.onrender.com"; // Your backend URL

    let currentScenes = [];

    document.getElementById("processBtn").addEventListener("click", async () => {
      const file = document.getElementById("videoUpload").files[0];
      if (!file) return alert("Please upload a video.");

      const formData = new FormData();
      formData.append("video", file);

      try {
        const res = await fetch(`${BACKEND_URL}/detect`, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) throw new Error("Failed to detect scenes.");

        const scenes = await res.json();
        currentScenes = scenes;
        const list = document.getElementById("sceneList");
        list.innerHTML = "<h3>Detected Scenes:</h3>";

        scenes.forEach((scene, i) => {
          const div = document.createElement("div");
          div.className = "scene";
          div.innerHTML = `
            <label>
              <input type="checkbox" data-index="${i}" checked />
              Scene ${i + 1}: ${scene.start}s ‚Üí ${scene.end}s
            </label>
            <button onclick="downloadScene(${i})">üìÅ Download This Scene</button>
          `;
          list.appendChild(div);
        });

        document.getElementById("downloadOptions").style.display = "block";
      } catch (error) {
        alert(error.message);
      }
    });

    async function downloadScene(index) {
      try {
        const res = await fetch(`${BACKEND_URL}/export`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ indices: [index] }),
        });

        if (!res.ok) throw new Error("Failed to download scene.");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `scene_${index + 1}.zip`;
        a.click();
      } catch (error) {
        alert(error.message);
      }
    }

    document.getElementById("downloadZipBtn").addEventListener("click", async () => {
      const checked = [...document.querySelectorAll('input[type="checkbox"]:checked')].map(
        (cb) => parseInt(cb.dataset.index)
      );

      if (checked.length === 0) return alert("Select at least one scene to download.");

      try {
        const res = await fetch(`${BACKEND_URL}/export`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ indices: checked }),
        });

        if (!res.ok) throw new Error("Failed to download zip.");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "scenes.zip";
        a.click();
      } catch (error) {
        alert(error.message);
      }
    });

    document.getElementById("downloadTimecodesBtn").addEventListener("click", () => {
      if (currentScenes.length === 0) return alert("No scenes detected yet.");
      const lines = currentScenes
        .map((scene, i) => `Scene ${i + 1}: ${scene.start}s - ${scene.end}s`)
        .join("\n");
      const blob = new Blob([lines], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "timecodes.txt";
      a.click();
    });
  </script>
</body>
</html>
